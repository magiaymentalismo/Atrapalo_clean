<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Cartelera — Magia & Teatro</title>

<style>
  :root{
    --bg:#000; --bg2:#090909; --panel:#0d0d0d;
    --ink:#f7f7f7; --muted:#b9b9b9; --hair:#272727;
    --gold:#d4af37; --green:#22c55e; --orange:#f59e0b; --sold:#6b7280;
    --r:.9rem; --rx:999px;
  }

  body{
    background:linear-gradient(180deg, var(--bg), var(--bg2));
    margin:0; color:var(--ink);
    font:600 16px/1.55 system-ui;
  }

  .wrap{max-width:1040px; margin:0 auto; padding:1rem}

  h1{margin:0 0 .35rem; font:900 24px/1.2 system-ui}

  #meta{margin-top:.25rem; color:var(--muted); font-size:.9rem}

  .tabs{
    display:flex; gap:.6rem; margin-top:.7rem;
    overflow-x:auto; padding:.2rem 0 .5rem;
  }
  .tab{
    padding:.7rem 1rem; border-radius:var(--rx);
    border:1px solid var(--hair); background:#161616;
    font-weight:800; cursor:pointer; color:var(--ink);
    white-space:nowrap;
  }
  .tab.active{
    background:var(--gold); color:#111;
  }

  /* SUBTABS */
  .subtabs{
    display:flex; gap:.5rem; margin:1rem 0 .8rem;
    border-bottom:1px solid var(--hair); padding-bottom:.4rem;
  }
  .subtab{
    padding:.45rem .9rem; border-radius:var(--rx);
    background:#141414; border:1px solid var(--hair);
    font-weight:800; cursor:pointer; color:#9ca3af;
  }
  .subtab.active{
    background:#fff; color:#111;
  }

  .panel{
    background:#111; padding:1rem; border-radius:var(--r);
  }

  .list{display:flex; flex-direction:column; gap:1rem}

  .item{
    padding:1rem; border-radius:var(--r);
    border:1px solid var(--hair);
    display:flex; justify-content:space-between;
    background:#161616;
  }

  .chip{
    padding:.4rem .8rem; border-radius:var(--rx);
    font-weight:900;
  }
  .chip.green{background:var(--green); color:#000}
  .chip.gold{background:var(--gold); color:#000}
  .chip.gray{background:#444}
  .chip.warn{background:var(--orange); color:#000}
  .chip.sold{background:#555; text-decoration:line-through}

  .month{
    margin:1.2rem 0 .4rem;
    font-weight:900;
    font-size:.96rem;
    text-transform:capitalize;
    color:var(--gold);
    letter-spacing:.03em;
  }

  .abono-chip{
    font-size:.78rem;
    padding:.25rem .7rem;
    opacity:0.95;
  }
</style>
</head>

<body>
<div class="wrap">
  <h1>Cartelera — Escalera & Escondido</h1>
  <div id="meta"></div>
  <div id="tabs" class="tabs"></div>

  <div class="panel">
    <div id="subtabs" class="subtabs"></div>
    <div id="list" class="list"></div>
  </div>
</div>

<script id="PAYLOAD" type="application/json">{"generated_at": "2025-11-29T07:22:33.289626+01:00", "eventos": {"Miedo": {"table": {"headers": ["Fecha", "Hora", "Vendidas", "FechaISO", "Capacidad", "Stock", "Abono"], "rows": [["12 Dec 2025", "23:00:", 9, "2025-12-12", 48, 39, null], ["19 Dec 2025", "23:00:", 0, "2025-12-19", 48, 48, null], ["22 Dec 2025", "21:30:", 5, "2025-12-22", 48, 43, null], ["26 Dec 2025", "23:00:", 0, "2025-12-26", 48, 48, null], ["09 Jan 2026", "23:00:", 0, "2026-01-09", 48, 48, null], ["16 Jan 2026", "23:00:", 0, "2026-01-16", 48, 48, null], ["23 Jan 2026", "23:00:", 0, "2026-01-23", 48, 48, null], ["30 Jan 2026", "23:00:", 0, "2026-01-30", 48, 48, null]]}, "proximas": {"table": {"headers": ["Fecha", "Hora", "Vendidas", "FechaISO", "Capacidad", "Stock", "Abono"], "rows": [["12 Dec 2025", "23:00:", 9, "2025-12-12", 48, 39, null], ["19 Dec 2025", "23:00:", 0, "2025-12-19", 48, 48, null], ["22 Dec 2025", "21:30:", 5, "2025-12-22", 48, 43, null], ["26 Dec 2025", "23:00:", 0, "2025-12-26", 48, 48, null], ["09 Jan 2026", "23:00:", 0, "2026-01-09", 48, 48, null], ["16 Jan 2026", "23:00:", 0, "2026-01-16", 48, 48, null], ["23 Jan 2026", "23:00:", 0, "2026-01-23", 48, 48, null], ["30 Jan 2026", "23:00:", 0, "2026-01-30", 48, 48, null]]}}, "pasadas": {"table": {"headers": ["Fecha", "Hora", "Vendidas", "FechaISO", "Capacidad", "Stock", "Abono"], "rows": []}}}, "Disfruta": {"table": {"headers": ["Fecha", "Hora", "Vendidas", "FechaISO", "Capacidad", "Stock", "Abono"], "rows": [["26 Nov 2025", "20:00:", 12, "2025-11-26", 48, 36, null], ["10 Dec 2025", "20:00:", 0, "2025-12-10", 48, 48, null], ["17 Dec 2025", "20:00:", 0, "2025-12-17", 48, 48, null], ["23 Dec 2025", "21:00:", 2, "2025-12-23", 51, 49, null], ["05 Jan 2026", "21:00:", 0, "2026-01-05", 51, 51, null], ["06 Jan 2026", "21:00:", 0, "2026-01-06", 51, 51, null], ["07 Jan 2026", "20:00:", 0, "2026-01-07", 48, 48, null], ["14 Jan 2026", "20:00:", 0, "2026-01-14", 48, 48, null], ["21 Jan 2026", "20:00:", 0, "2026-01-21", 48, 48, null], ["28 Jan 2026", "20:00:", 0, "2026-01-28", 48, 48, null]]}, "proximas": {"table": {"headers": ["Fecha", "Hora", "Vendidas", "FechaISO", "Capacidad", "Stock", "Abono"], "rows": [["10 Dec 2025", "20:00:", 0, "2025-12-10", 48, 48, null], ["17 Dec 2025", "20:00:", 0, "2025-12-17", 48, 48, null], ["23 Dec 2025", "21:00:", 2, "2025-12-23", 51, 49, null], ["05 Jan 2026", "21:00:", 0, "2026-01-05", 51, 51, null], ["06 Jan 2026", "21:00:", 0, "2026-01-06", 51, 51, null], ["07 Jan 2026", "20:00:", 0, "2026-01-07", 48, 48, null], ["14 Jan 2026", "20:00:", 0, "2026-01-14", 48, 48, null], ["21 Jan 2026", "20:00:", 0, "2026-01-21", 48, 48, null], ["28 Jan 2026", "20:00:", 0, "2026-01-28", 48, 48, null]]}}, "pasadas": {"table": {"headers": ["Fecha", "Hora", "Vendidas", "FechaISO", "Capacidad", "Stock", "Abono"], "rows": [["26 Nov 2025", "20:00:", 12, "2025-11-26", 48, 36, null]]}}}, "Escondido": {"table": {"headers": ["Fecha", "Hora", "Vendidas", "FechaISO", "Capacidad", "Stock", "Abono"], "rows": [["12 Dec 2025", "20:00:", 2, "2025-12-12", 60, 58, "venta"], ["13 Dec 2025", "17:00:", 0, "2025-12-13", 0, 0, "agotado"], ["14 Dec 2025", "18:30:", 13, "2025-12-14", 60, 47, "agotado"], ["21 Dec 2025", "18:30:", 20, "2025-12-21", 35, 15, "agotado"], ["27 Dec 2025", "17:00:", 0, "2025-12-27", 30, 30, "venta"], ["28 Dec 2025", "18:30:", 8, "2025-12-28", 35, 27, "agotado"], ["08 Jan 2026", "20:00:", 0, "2026-01-08", 20, 20, "venta"], ["10 Jan 2026", "17:00:", 0, "2026-01-10", 20, 20, "venta"], ["11 Jan 2026", "18:30:", 0, "2026-01-11", 35, 35, "agotado"], ["15 Jan 2026", "20:00:", 0, "2026-01-15", 20, 20, "venta"], ["17 Jan 2026", "17:00:", 0, "2026-01-17", 20, 20, "venta"], ["18 Jan 2026", "18:30:", 0, "2026-01-18", 0, 0, "agotado"], ["22 Jan 2026", "20:00:", 0, "2026-01-22", 20, 20, "venta"], ["24 Jan 2026", "17:00:", 0, "2026-01-24", 20, 20, "venta"], ["31 Jan 2026", "17:00:", 0, "2026-01-31", 20, 20, "agotado"], ["14 Feb 2026", "17:00:", 0, "2026-02-14", 20, 20, "agotado"], ["28 Feb 2026", "17:00:", 0, "2026-02-28", 20, 20, "agotado"]]}, "proximas": {"table": {"headers": ["Fecha", "Hora", "Vendidas", "FechaISO", "Capacidad", "Stock", "Abono"], "rows": [["12 Dec 2025", "20:00:", 2, "2025-12-12", 60, 58, "venta"], ["13 Dec 2025", "17:00:", 0, "2025-12-13", 0, 0, "agotado"], ["14 Dec 2025", "18:30:", 13, "2025-12-14", 60, 47, "agotado"], ["21 Dec 2025", "18:30:", 20, "2025-12-21", 35, 15, "agotado"], ["27 Dec 2025", "17:00:", 0, "2025-12-27", 30, 30, "venta"], ["28 Dec 2025", "18:30:", 8, "2025-12-28", 35, 27, "agotado"], ["08 Jan 2026", "20:00:", 0, "2026-01-08", 20, 20, "venta"], ["10 Jan 2026", "17:00:", 0, "2026-01-10", 20, 20, "venta"], ["11 Jan 2026", "18:30:", 0, "2026-01-11", 35, 35, "agotado"], ["15 Jan 2026", "20:00:", 0, "2026-01-15", 20, 20, "venta"], ["17 Jan 2026", "17:00:", 0, "2026-01-17", 20, 20, "venta"], ["18 Jan 2026", "18:30:", 0, "2026-01-18", 0, 0, "agotado"], ["22 Jan 2026", "20:00:", 0, "2026-01-22", 20, 20, "venta"], ["24 Jan 2026", "17:00:", 0, "2026-01-24", 20, 20, "venta"], ["31 Jan 2026", "17:00:", 0, "2026-01-31", 20, 20, "agotado"], ["14 Feb 2026", "17:00:", 0, "2026-02-14", 20, 20, "agotado"], ["28 Feb 2026", "17:00:", 0, "2026-02-28", 20, 20, "agotado"]]}}, "pasadas": {"table": {"headers": ["Fecha", "Hora", "Vendidas", "FechaISO", "Capacidad", "Stock", "Abono"], "rows": []}}}}}</script>

<script>
const payload = JSON.parse(document.getElementById("PAYLOAD").textContent);
const eventos = payload.eventos || {};
let active = Object.keys(eventos)[0] || null;
let subMode = "proximas"; // o "pasadas"

document.getElementById("meta").textContent =
  "Generado: " + new Date(payload.generated_at).toLocaleString("es-ES");

// === Crear tabs principales (con contador) ===
const tabsEl = document.getElementById("tabs");
for (const sala of Object.keys(eventos)) {
  const ev = eventos[sala];

  let total = 0;
  if (ev.proximas && ev.proximas.table && Array.isArray(ev.proximas.table.rows)) {
    total += ev.proximas.table.rows.length;
  }
  if (ev.pasadas && ev.pasadas.table && Array.isArray(ev.pasadas.table.rows)) {
    total += ev.pasadas.table.rows.length;
  }
  if (!total && ev.table && Array.isArray(ev.table.rows)) {
    total = ev.table.rows.length;
  }

  const b = document.createElement("button");
  b.textContent = `${sala} (${total})`;
  b.dataset.tab = sala;
  b.className = "tab" + (sala === active ? " active" : "");
  b.onclick = () => { active = sala; updateTabs(); render(); };
  tabsEl.appendChild(b);
}

function updateTabs(){
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.dataset.tab === active);
  });
}

// === Crear subtabs ===
const subtabsEl = document.getElementById("subtabs");
["proximas","pasadas"].forEach(mode=>{
  const sb = document.createElement("button");
  sb.textContent = mode==="proximas" ? "Próximas" : "Pasadas";
  sb.dataset.mode = mode;
  sb.className = "subtab" + (subMode===mode ? " active" : "");
  sb.onclick = () => { subMode = mode; updateSubtabs(); render(); };
  subtabsEl.appendChild(sb);
});

function updateSubtabs(){
  document.querySelectorAll(".subtab").forEach(s=>{
    s.classList.toggle("active", s.dataset.mode === subMode);
  });
}

// === Día de la semana ===
const DAYS = ["Dom","Lun","Mar","Mié","Jue","Vie","Sáb"];
function dayName(fechaIso){
  const d = new Date(fechaIso + "T00:00:00");
  return DAYS[d.getDay()];
}

// ---- Util para leer filas según estructura del payload ----
function getRowsForActiveAndMode(){
  const ev = eventos[active];
  if (!ev) return [];

  // Caso 1: payload con proximas/pasadas
  if (ev.proximas || ev.pasadas){
    const sec = ev[subMode];
    if (!sec || !sec.table || !Array.isArray(sec.table.rows)) return [];
    return sec.table.rows || [];
  }

  // Caso 2 (fallback): payload plano con table.rows y filtramos aquí
  if (!ev.table || !Array.isArray(ev.table.rows)) return [];
  let rows = ev.table.rows;

  rows = rows.map(r => ({
    fecha_label: r[0],
    hora: r[1],
    vendidas: r[2],
    fecha_iso: r[3],
    cap: r[4],
    stock: r[5],
    abono: (r.length >= 7 ? r[6] : null)
  }));

  const today = new Date();
  today.setHours(0,0,0,0);

  rows = rows.filter(r=>{
    const hora = r.hora || "00:00";
    const dt = new Date(r.fecha_iso + "T" + hora + ":00");
    const dtDay = new Date(dt);
    dtDay.setHours(0,0,0,0);
    return subMode === "pasadas" ? dtDay < today : dtDay >= today;
  });

  return rows.map(r => [r.fecha_label, r.hora, r.vendidas, r.fecha_iso, r.cap, r.stock, r.abono]);
}

// === Render ===
function render(){
  const cont = document.getElementById("list");
  cont.innerHTML = "";
  if (!active || !eventos[active]) return;

  let rows = getRowsForActiveAndMode();
  if (!rows || rows.length === 0){
    cont.innerHTML = "<p style='color:#9ca3af'>Sin funciones en esta vista.</p>";
    return;
  }

  // Parse rows normalizados (7 columnas: incluye Abono)
  rows = rows.map(r => ({
    fecha_label: r[0],
    hora: r[1],
    vendidas: r[2],
    fecha_iso: r[3],
    cap: r[4],
    stock: r[5],
    abono: (r.length >= 7 ? r[6] : null)
  }));

  // Ordenar
  rows.sort((a,b)=> (a.fecha_iso + a.hora).localeCompare(b.fecha_iso + b.hora));

  // Agrupar por mes
  let currentMonthKey = null;
  for (const r of rows){
    const d = new Date(r.fecha_iso + "T00:00:00");
    const monthKey = d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0");
    if (monthKey !== currentMonthKey){
      currentMonthKey = monthKey;
      const label = d.toLocaleDateString("es-ES", { month: "long", year: "numeric" });
      const h = document.createElement("h3");
      h.className = "month";
      h.textContent = label;
      cont.appendChild(h);
    }

    const div = document.createElement("div");
    div.className="item";

    // chip color por vendidas
    let chip="gray";
    if (r.vendidas >=10) chip="gold";
    else if (r.vendidas >=1) chip="green";
    if (r.stock === 0) chip="sold";

    const esEscondido = (active === "Escondido");
    let abonoHTML = "";
    if (esEscondido && r.abono) {
      if (r.abono === "venta") {
        abonoHTML = `<div class="chip green abono-chip">Abono Teatro: siguen en venta</div>`;
      } else if (r.abono === "agotado") {
        abonoHTML = `<div class="chip sold abono-chip">Abono Teatro agotado</div>`;
      }
    }

    // === Texto "vendidas / capacidad" para Escondido ===
    let ventaLabel = `Vendidas: ${r.vendidas}`;
    if (esEscondido && r.cap){
      const cap = Number(r.cap) || 0;
      const stock = (typeof r.stock === "number") ? r.stock : null;
      const quedanTxt = (stock !== null) ? ` · quedan ${stock}` : "";
      ventaLabel = `Vendidas: ${r.vendidas} / ${cap}${quedanTxt}`;
    }

    const diaSemana = dayName(r.fecha_iso);

    div.innerHTML = `
      <div><b>${r.fecha_label} (${diaSemana})</b> — ${r.hora}</div>
      <div style="display:flex; flex-direction:column; gap:.3rem; align-items:flex-end">
        <div class="chip ${chip}">${ventaLabel}</div>
        ${abonoHTML}
      </div>
    `;
    cont.appendChild(div);
  }
}

render();
</script>
</body>
</html>

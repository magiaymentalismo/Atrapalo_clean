<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Cartelera — Magia & Teatro</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
  :root{
    --bg-deep: #000000;
    --glass-surface: rgba(255, 255, 255, 0.08);
    --glass-border: rgba(255, 255, 255, 0.12);
    --glass-highlight: rgba(255, 255, 255, 0.2);
    --text-primary: #ffffff;
    --text-secondary: rgba(255, 255, 255, 0.6);
    --accent-gold: #ffd700;
    --accent-green: #34c759;
    --accent-orange: #ff9f0a;
    --accent-red: #ff453a;
    
    --blur-md: 20px;
    --radius-lg: 24px;
    --radius-md: 16px;
    --radius-full: 999px;
    
    --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
  }

  body {
    background-color: var(--bg-deep);
    background-image: 
      radial-gradient(circle at 10% 20%, rgba(60, 20, 100, 0.4) 0%, transparent 40%),
      radial-gradient(circle at 90% 80%, rgba(0, 80, 100, 0.3) 0%, transparent 40%),
      radial-gradient(circle at 50% 50%, rgba(40, 40, 40, 0.5) 0%, transparent 60%);
    background-attachment: fixed;
    margin: 0;
    color: var(--text-primary);
    font-family: var(--font-stack);
    -webkit-font-smoothing: antialiased;
    min-height: 100vh;
    padding-bottom: 40px;
    padding-top: env(safe-area-inset-top);
  }

  .wrap {
    max-width: 1040px;
    margin: 0 auto;
    padding: 20px;
  }

  h1 {
    margin: 20px 0 8px;
    font-size: 34px;
    font-weight: 800;
    letter-spacing: -0.5px;
    background: linear-gradient(135deg, #fff 0%, #ccc 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow: 0 10px 30px rgba(0,0,0,0.5);
    view-transition-name: header-title;
  }

  #meta {
    margin-bottom: 24px;
    color: var(--text-secondary);
    font-size: 15px;
    font-weight: 500;
  }

  /* --- TABS --- */
  .tabs {
    display: flex;
    gap: 12px;
    margin-bottom: 24px;
    overflow-x: auto;
    padding: 4px;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    view-transition-name: tabs-container;
  }
  .tabs::-webkit-scrollbar { display: none; }

  .tab {
    padding: 12px 20px;
    border-radius: var(--radius-full);
    background: var(--glass-surface);
    border: 1px solid var(--glass-border);
    color: var(--text-secondary);
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    backdrop-filter: blur(var(--blur-md));
    -webkit-backdrop-filter: blur(var(--blur-md));
  }
  .tab:hover {
    background: rgba(255, 255, 255, 0.15);
  }
  .tab.active {
    background: rgba(255, 255, 255, 0.9);
    color: #000;
    border-color: transparent;
    box-shadow: 0 4px 20px rgba(255, 255, 255, 0.2);
    transform: scale(1.02);
    view-transition-name: active-tab;
  }

  /* --- PANEL --- */
  .panel {
    background: rgba(20, 20, 20, 0.4);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-lg);
    padding: 24px;
    backdrop-filter: blur(40px);
    -webkit-backdrop-filter: blur(40px);
    box-shadow: 0 20px 40px rgba(0,0,0,0.4);
    view-transition-name: content-panel;
  }

  /* --- SUBTABS --- */
  .subtabs {
    display: inline-flex;
    background: rgba(0, 0, 0, 0.3);
    padding: 4px;
    border-radius: var(--radius-full);
    margin-bottom: 24px;
    border: 1px solid var(--glass-border);
  }
  .subtab {
    padding: 8px 20px;
    border-radius: var(--radius-full);
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    background: transparent;
    transition: all 0.2s ease;
  }
  .subtab.active {
    background: rgba(255, 255, 255, 0.15);
    color: #fff;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    view-transition-name: active-subtab;
  }

  /* --- LIST & ITEMS --- */
  .list {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .month {
    margin: 32px 0 12px;
    font-size: 20px;
    font-weight: 700;
    color: var(--accent-gold);
    text-transform: capitalize;
    letter-spacing: 0.5px;
    padding-left: 8px;
  }

  .item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-md);
    transition: transform 0.2s ease, background 0.2s ease;
  }
  .item:hover {
    background: rgba(255, 255, 255, 0.06);
    transform: translateY(-2px);
  }

  .item-left {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .item-date {
    font-size: 17px;
    font-weight: 600;
    color: #fff;
  }
  .item-time {
    font-size: 15px;
    color: var(--text-secondary);
    font-weight: 500;
  }

  .item-right {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 8px;
  }

  /* --- CHIPS --- */
  .chip {
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 0.3px;
    text-transform: uppercase;
    backdrop-filter: blur(10px);
  }
  .chip.green {
    background: rgba(52, 199, 89, 0.2);
    color: var(--accent-green);
    border: 1px solid rgba(52, 199, 89, 0.3);
  }
  .chip.gold {
    background: rgba(255, 215, 0, 0.15);
    color: var(--accent-gold);
    border: 1px solid rgba(255, 215, 0, 0.3);
  }
  .chip.gray {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-secondary);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
  .chip.sold {
    background: rgba(255, 69, 58, 0.15);
    color: var(--accent-red);
    border: 1px solid rgba(255, 69, 58, 0.3);
    text-decoration: line-through;
  }
  
  .abono-chip {
    font-size: 11px;
    padding: 4px 8px;
    border-radius: 6px;
    opacity: 0.9;
  }

  @media (max-width: 600px) {
    .wrap { padding: 16px; }
    h1 { font-size: 28px; }
    .item { padding: 16px; }
    .item-date { font-size: 16px; }
  }

  /* View Transitions */
  ::view-transition-old(root),
  ::view-transition-new(root) {
    animation-duration: 0.3s;
  }
</style>
</head>

<body>
<div class="wrap">
  <h1>Cartelera — Escalera & Escondido</h1>
  <div id="meta"></div>
  <div id="tabs" class="tabs"></div>

  <div class="panel">
    <div id="subtabs" class="subtabs"></div>
    <div id="list" class="list"></div>
  </div>
</div>

<script id="PAYLOAD" type="application/json">{"generated_at": "2025-11-30T22:54:17.324562+01:00", "eventos": {"Miedo": {"table": {"headers": ["Fecha", "Hora", "Vendidas", "FechaISO", "Capacidad", "Stock", "Abono"], "rows": [["12 Dec 2025", "23:00:", 9, "2025-12-12", 48, 39, null], ["19 Dec 2025", "23:00:", 0, "2025-12-19", 48, 48, null], ["22 Dec 2025", "21:30:", 5, "2025-12-22", 48, 43, null], ["26 Dec 2025", "23:00:", 0, "2025-12-26", 48, 48, null], ["09 Jan 2026", "23:00:", 0, "2026-01-09", 48, 48, null], ["16 Jan 2026", "23:00:", 0, "2026-01-16", 48, 48, null], ["23 Jan 2026", "23:00:", 0, "2026-01-23", 48, 48, null], ["30 Jan 2026", "23:00:", 0, "2026-01-30", 48, 48, null]]}, "proximas": {"table": {"headers": ["Fecha", "Hora", "Vendidas", "FechaISO", "Capacidad", "Stock", "Abono"], "rows": [["12 Dec 2025", "23:00:", 9, "2025-12-12", 48, 39, null], ["19 Dec 2025", "23:00:", 0, "2025-12-19", 48, 48, null], ["22 Dec 2025", "21:30:", 5, "2025-12-22", 48, 43, null], ["26 Dec 2025", "23:00:", 0, "2025-12-26", 48, 48, null], ["09 Jan 2026", "23:00:", 0, "2026-01-09", 48, 48, null], ["16 Jan 2026", "23:00:", 0, "2026-01-16", 48, 48, null], ["23 Jan 2026", "23:00:", 0, "2026-01-23", 48, 48, null], ["30 Jan 2026", "23:00:", 0, "2026-01-30", 48, 48, null]]}}, "pasadas": {"table": {"headers": ["Fecha", "Hora", "Vendidas", "FechaISO", "Capacidad", "Stock", "Abono"], "rows": []}}}, "Escondido": {"table": {"headers": ["Fecha", "Hora", "Vendidas", "FechaISO", "Capacidad", "Stock", "Abono"], "rows": [["12 Dec 2025", "20:00:", 7, "2025-12-12", 60, 53, "venta"], ["13 Dec 2025", "17:00:", 0, "2025-12-13", 0, 0, "agotado"], ["14 Dec 2025", "18:30:", 13, "2025-12-14", 60, 47, "agotado"], ["21 Dec 2025", "18:30:", 20, "2025-12-21", 35, 15, "agotado"], ["27 Dec 2025", "17:00:", 6, "2025-12-27", 30, 24, "venta"], ["28 Dec 2025", "18:30:", 11, "2025-12-28", 35, 24, "agotado"], ["08 Jan 2026", "20:00:", 0, "2026-01-08", 20, 20, "venta"], ["10 Jan 2026", "17:00:", 0, "2026-01-10", 20, 20, "venta"], ["11 Jan 2026", "18:30:", 0, "2026-01-11", 35, 35, "agotado"], ["15 Jan 2026", "20:00:", 0, "2026-01-15", 20, 20, "venta"], ["17 Jan 2026", "17:00:", 2, "2026-01-17", 20, 18, "venta"], ["18 Jan 2026", "18:30:", 0, "2026-01-18", 0, 0, "agotado"], ["22 Jan 2026", "20:00:", 0, "2026-01-22", 20, 20, "venta"], ["24 Jan 2026", "17:00:", 0, "2026-01-24", 20, 20, "venta"], ["31 Jan 2026", "17:00:", 0, "2026-01-31", 20, 20, "agotado"], ["14 Feb 2026", "17:00:", 0, "2026-02-14", 20, 20, "agotado"], ["28 Feb 2026", "17:00:", 0, "2026-02-28", 20, 20, "agotado"]]}, "proximas": {"table": {"headers": ["Fecha", "Hora", "Vendidas", "FechaISO", "Capacidad", "Stock", "Abono"], "rows": [["12 Dec 2025", "20:00:", 7, "2025-12-12", 60, 53, "venta"], ["13 Dec 2025", "17:00:", 0, "2025-12-13", 0, 0, "agotado"], ["14 Dec 2025", "18:30:", 13, "2025-12-14", 60, 47, "agotado"], ["21 Dec 2025", "18:30:", 20, "2025-12-21", 35, 15, "agotado"], ["27 Dec 2025", "17:00:", 6, "2025-12-27", 30, 24, "venta"], ["28 Dec 2025", "18:30:", 11, "2025-12-28", 35, 24, "agotado"], ["08 Jan 2026", "20:00:", 0, "2026-01-08", 20, 20, "venta"], ["10 Jan 2026", "17:00:", 0, "2026-01-10", 20, 20, "venta"], ["11 Jan 2026", "18:30:", 0, "2026-01-11", 35, 35, "agotado"], ["15 Jan 2026", "20:00:", 0, "2026-01-15", 20, 20, "venta"], ["17 Jan 2026", "17:00:", 2, "2026-01-17", 20, 18, "venta"], ["18 Jan 2026", "18:30:", 0, "2026-01-18", 0, 0, "agotado"], ["22 Jan 2026", "20:00:", 0, "2026-01-22", 20, 20, "venta"], ["24 Jan 2026", "17:00:", 0, "2026-01-24", 20, 20, "venta"], ["31 Jan 2026", "17:00:", 0, "2026-01-31", 20, 20, "agotado"], ["14 Feb 2026", "17:00:", 0, "2026-02-14", 20, 20, "agotado"], ["28 Feb 2026", "17:00:", 0, "2026-02-28", 20, 20, "agotado"]]}}, "pasadas": {"table": {"headers": ["Fecha", "Hora", "Vendidas", "FechaISO", "Capacidad", "Stock", "Abono"], "rows": []}}}, "Disfruta": {"table": {"headers": ["Fecha", "Hora", "Vendidas", "FechaISO", "Capacidad", "Stock", "Abono"], "rows": [["26 Nov 2025", "20:00:", 12, "2025-11-26", 48, 36, null], ["10 Dec 2025", "20:00:", 0, "2025-12-10", 48, 48, null], ["17 Dec 2025", "20:00:", 0, "2025-12-17", 48, 48, null], ["23 Dec 2025", "21:00:", 5, "2025-12-23", 51, 46, null], ["05 Jan 2026", "21:00:", 0, "2026-01-05", 51, 51, null], ["06 Jan 2026", "21:00:", 0, "2026-01-06", 51, 51, null], ["07 Jan 2026", "20:00:", 0, "2026-01-07", 48, 48, null], ["14 Jan 2026", "20:00:", 0, "2026-01-14", 48, 48, null], ["21 Jan 2026", "20:00:", 0, "2026-01-21", 48, 48, null], ["28 Jan 2026", "20:00:", 0, "2026-01-28", 48, 48, null]]}, "proximas": {"table": {"headers": ["Fecha", "Hora", "Vendidas", "FechaISO", "Capacidad", "Stock", "Abono"], "rows": [["10 Dec 2025", "20:00:", 0, "2025-12-10", 48, 48, null], ["17 Dec 2025", "20:00:", 0, "2025-12-17", 48, 48, null], ["23 Dec 2025", "21:00:", 5, "2025-12-23", 51, 46, null], ["05 Jan 2026", "21:00:", 0, "2026-01-05", 51, 51, null], ["06 Jan 2026", "21:00:", 0, "2026-01-06", 51, 51, null], ["07 Jan 2026", "20:00:", 0, "2026-01-07", 48, 48, null], ["14 Jan 2026", "20:00:", 0, "2026-01-14", 48, 48, null], ["21 Jan 2026", "20:00:", 0, "2026-01-21", 48, 48, null], ["28 Jan 2026", "20:00:", 0, "2026-01-28", 48, 48, null]]}}, "pasadas": {"table": {"headers": ["Fecha", "Hora", "Vendidas", "FechaISO", "Capacidad", "Stock", "Abono"], "rows": [["26 Nov 2025", "20:00:", 12, "2025-11-26", 48, 36, null]]}}}}}</script>

<script>
const payload = JSON.parse(document.getElementById("PAYLOAD").textContent);
const eventos = payload.eventos || {};
let active = Object.keys(eventos)[0] || null;
let subMode = "proximas"; // o "pasadas"

document.getElementById("meta").textContent =
  "Actualizado: " + new Date(payload.generated_at).toLocaleString("es-ES", {
    dateStyle: 'medium', timeStyle: 'short'
  });

// === Crear tabs principales (con contador) ===
const tabsEl = document.getElementById("tabs");
for (const sala of Object.keys(eventos)) {
  const ev = eventos[sala];

  let total = 0;
  if (ev.proximas && ev.proximas.table && Array.isArray(ev.proximas.table.rows)) {
    total += ev.proximas.table.rows.length;
  }
  if (ev.pasadas && ev.pasadas.table && Array.isArray(ev.pasadas.table.rows)) {
    total += ev.pasadas.table.rows.length;
  }
  if (!total && ev.table && Array.isArray(ev.table.rows)) {
    total = ev.table.rows.length;
  }

  const b = document.createElement("button");
  b.textContent = `${sala} (${total})`;
  b.dataset.tab = sala;
  b.className = "tab" + (sala === active ? " active" : "");
  b.onclick = () => {
    if (document.startViewTransition) {
      document.startViewTransition(() => {
        active = sala; updateTabs(); render();
      });
    } else {
      active = sala; updateTabs(); render();
    }
  };
  tabsEl.appendChild(b);
}

function updateTabs(){
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.dataset.tab === active);
  });
}

// === Crear subtabs ===
const subtabsEl = document.getElementById("subtabs");
["proximas","pasadas"].forEach(mode=>{
  const sb = document.createElement("button");
  sb.textContent = mode==="proximas" ? "Próximas" : "Pasadas";
  sb.dataset.mode = mode;
  sb.className = "subtab" + (subMode===mode ? " active" : "");
  sb.onclick = () => {
    if (document.startViewTransition) {
      document.startViewTransition(() => {
        subMode = mode; updateSubtabs(); render();
      });
    } else {
      subMode = mode; updateSubtabs(); render();
    }
  };
  subtabsEl.appendChild(sb);
});

function updateSubtabs(){
  document.querySelectorAll(".subtab").forEach(s=>{
    s.classList.toggle("active", s.dataset.mode === subMode);
  });
}

// === Día de la semana ===
const DAYS = ["Dom","Lun","Mar","Mié","Jue","Vie","Sáb"];
function dayName(fechaIso){
  const d = new Date(fechaIso + "T00:00:00");
  return DAYS[d.getDay()];
}

// ---- Util para leer filas según estructura del payload ----
function getRowsForActiveAndMode(){
  const ev = eventos[active];
  if (!ev) return [];

  // Caso 1: payload con proximas/pasadas
  if (ev.proximas || ev.pasadas){
    const sec = ev[subMode];
    if (!sec || !sec.table || !Array.isArray(sec.table.rows)) return [];
    return sec.table.rows || [];
  }

  // Caso 2 (fallback): payload plano con table.rows y filtramos aquí
  if (!ev.table || !Array.isArray(ev.table.rows)) return [];
  let rows = ev.table.rows;

  rows = rows.map(r => ({
    fecha_label: r[0],
    hora: r[1],
    vendidas: r[2],
    fecha_iso: r[3],
    cap: r[4],
    stock: r[5],
    abono: (r.length >= 7 ? r[6] : null)
  }));

  const today = new Date();
  today.setHours(0,0,0,0);

  rows = rows.filter(r=>{
    const hora = r.hora || "00:00";
    const dt = new Date(r.fecha_iso + "T" + hora + ":00");
    const dtDay = new Date(dt);
    dtDay.setHours(0,0,0,0);
    return subMode === "pasadas" ? dtDay < today : dtDay >= today;
  });

  return rows.map(r => [r.fecha_label, r.hora, r.vendidas, r.fecha_iso, r.cap, r.stock, r.abono]);
}

// === Render ===
function render(){
  const cont = document.getElementById("list");
  cont.innerHTML = "";
  if (!active || !eventos[active]) return;

  let rows = getRowsForActiveAndMode();
  if (!rows || rows.length === 0){
    cont.innerHTML = "<p style='color:var(--text-secondary); text-align:center; padding:20px;'>Sin funciones en esta vista.</p>";
    return;
  }

  // Parse rows normalizados (7 columnas: incluye Abono)
  rows = rows.map(r => ({
    fecha_label: r[0],
    hora: r[1],
    vendidas: r[2],
    fecha_iso: r[3],
    cap: r[4],
    stock: r[5],
    abono: (r.length >= 7 ? r[6] : null)
  }));

  // Ordenar
  rows.sort((a,b)=> (a.fecha_iso + a.hora).localeCompare(b.fecha_iso + b.hora));

  // Agrupar por mes
  let currentMonthKey = null;
  for (const r of rows){
    const d = new Date(r.fecha_iso + "T00:00:00");
    const monthKey = d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0");
    if (monthKey !== currentMonthKey){
      currentMonthKey = monthKey;
      const label = d.toLocaleDateString("es-ES", { month: "long", year: "numeric" });
      const h = document.createElement("h3");
      h.className = "month";
      h.textContent = label;
      cont.appendChild(h);
    }

    const div = document.createElement("div");
    div.className="item";

    // chip color por vendidas
    let chip="gray";
    if (r.vendidas >=10) chip="gold";
    else if (r.vendidas >=1) chip="green";
    if (r.stock === 0) chip="sold";

    const esEscondido = (active === "Escondido");
    let abonoHTML = "";
    if (esEscondido && r.abono) {
      if (r.abono === "venta") {
        abonoHTML = `<div class="chip green abono-chip">Abono: Disponible</div>`;
      } else if (r.abono === "agotado") {
        abonoHTML = `<div class="chip sold abono-chip">Abono: Agotado</div>`;
      }
    }

    // === Texto "vendidas / capacidad" para Escondido ===
    let ventaLabel = `Vendidas: ${r.vendidas}`;
    if (esEscondido && r.cap){
      const cap = Number(r.cap) || 0;
      const stock = (typeof r.stock === "number") ? r.stock : null;
      const quedanTxt = (stock !== null) ? ` · Quedan ${stock}` : "";
      ventaLabel = `${r.vendidas} / ${cap}${quedanTxt}`;
    }

    const diaSemana = dayName(r.fecha_iso);

    div.innerHTML = `
      <div class="item-left">
        <div class="item-date">${r.fecha_label} <span style="opacity:0.6; font-weight:400">(${diaSemana})</span></div>
        <div class="item-time">${r.hora} h</div>
      </div>
      <div class="item-right">
        <div class="chip ${chip}">${ventaLabel}</div>
        ${abonoHTML}
      </div>
    `;
    cont.appendChild(div);
  }
}

// Register Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js');
  });
}

render();
</script>
</body>
</html>
